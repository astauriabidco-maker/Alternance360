generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. Tenants (CFA)
model Tenant {
  id           String    @id @default(uuid())
  name         String
  logoUrl      String?
  primaryColor String?   @default("#4f46e5")
  
  // Compliance & Branding
  siret        String?   @unique
  address      String?
  ndaNumber    String?
  uaiCode      String?
  qualiopiCert Boolean   @default(false)
  
  legalRep     String?
  contactEmail String?
  contactPhone String?
  website      String?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  users            User[]
  referentiels     Referentiel[]
  blocsCompetences BlocCompetence[]
  competences      Competence[]
  contracts        Contract[]
  livrets          Livret[]
  subscription     Subscription?
  auditSessions    AuditSession[]
  roles            Role[]
  trainingOffers   TrainingOffer[]
}

// 2. Users (Apprentice, Tutor, Formateur, Admin)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?  // Hashed password for local auth
  fullName  String?
  firstName String?
  lastName  String?
  phone     String?
  companyName String?
  tutorName   String?
  
  role      String   @default("apprentice") // admin, formateur, tutor, apprentice, super_admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // RBAC
  roleId   String?
  customRole Role? @relation(fields: [roleId], references: [id], onDelete: SetNull)

  // Relations
  proofs        Proof[]
  positionings  Positioning[]
  initialAssessments InitialAssessment[]
  
  contracts        Contract[] @relation("ApprenticeContracts")
  contractsManaged Contract[] @relation("FormateurContracts")
  
  activities    Activity[] // If activities are direct

  comments        ProofComment[]
  notifications   NotificationLog[]
  evaluationsReceived EvaluationIndicateur[] @relation("ApprenticeEvaluations")
  evaluationsValidated EvaluationIndicateur[] @relation("TutorEvaluations")
  reportsGenerated HistoricalReport[]
}

// 3. Referentiels (RNCP)
model Referentiel {
  id        String   @id @default(uuid())
  codeRncp  String
  title     String
  isGlobal  Boolean  @default(false) // If true, available to all CFAs for import
  createdAt DateTime @default(now())

  // Marketplace Metadata
  author             String?
  downloadCount      Int      @default(0)
  certificationLevel String?  // CAP, BTS, Licence Pro, etc.

  tenantId String? // Optional if isGlobal
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  blocs     BlocCompetence[]
  contracts Contract[]
  trainingOffers TrainingOffer[]
}



model BlocCompetence {
  id          String   @id @default(uuid())
  title       String
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())

  tenantId      String?
  tenant        Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referentielId String
  referentiel   Referentiel @relation(fields: [referentielId], references: [id], onDelete: Cascade)

  competences Competence[]
}

model Competence {
  id          String   @id @default(uuid())
  description String
  createdAt   DateTime @default(now())

  tenantId String?
  tenant   Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  blocId   String
  bloc     BlocCompetence @relation(fields: [blocId], references: [id], onDelete: Cascade)

  indicateurs  Indicateur[]
  tsfMappings  TSFMapping[]
  positionings Positioning[]
  proofs       Proof[] // Added relation
}

model Indicateur {
  id           String   @id @default(uuid())
  description  String
  createdAt    DateTime @default(now())

  competenceId String
  competence   Competence @relation(fields: [competenceId], references: [id], onDelete: Cascade)
  
  evaluations  EvaluationIndicateur[]
}

model EvaluationIndicateur {
  id           String   @id @default(uuid())
  status       String   @default("PENDING") // PENDING, ACQUIS, NON_ACQUIS, IN_PROGRESS
  comment      String? // Commentaire tuteur
  
  // Validation Proof
  isSigned     Boolean   @default(false)
  signedAt     DateTime?
  signatureData String?  // Base64/SVG signature

  checkedAt    DateTime?
  
  // Actor: Tutor/Validator
  validatorId  String?
  validator    User?    @relation("TutorEvaluations", fields: [validatorId], references: [id])

  // Actor: Apprentice (explicit link requested)
  apprenticeId String?
  apprentice   User?     @relation("ApprenticeEvaluations", fields: [apprenticeId], references: [id])

  // Context: Contract (Keep for history/multi-contract)
  contractId   String
  contract     Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  indicateurId String
  indicateur   Indicateur @relation(fields: [indicateurId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([contractId, indicateurId])
  @@index([apprenticeId])
  @@index([validatorId])
  @@index([indicateurId])
}

// 4. Contracts & TSF
model Contract {
  id           String   @id @default(uuid())
  startDate    DateTime
  endDate      DateTime
  
  // Final Validation
  tutorSignature String? // Base64 or URL
  signedAt       DateTime?

  createdAt    DateTime @default(now())

  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referentielId String?
  referentiel   Referentiel? @relation(fields: [referentielId], references: [id], onDelete: Cascade)
  
  userId        String?
  user          User?       @relation("ApprenticeContracts", fields: [userId], references: [id], onDelete: Cascade)

  formateurId   String?
  formateur     User?       @relation("FormateurContracts", fields: [formateurId], references: [id])

  versionId     String?     // For non-retroactivity snapshots
  periodType    String?     @default("SEMESTER") // SEMESTER, TRIMESTER, MONTH
  
  tsfStatus     String      @default("DRAFT")    // DRAFT (pre-positioning), VALIDATED (post J+7)
  isLocked      Boolean     @default(false)      // Locked after J+7 signature
  lockedAt      DateTime?
  changeLog     String?     // JSON or text string explaining version changes

  periodes   Period[]
  tsfMapping TSFMapping[]
  initialAssessments InitialAssessment[]
  milestones  Milestone[]
  attendance  Attendance[]
  livrets     Livret[]
  tsfEvaluations EvaluationIndicateur[]
  reports     HistoricalReport[]
}

model Period {
  id         String   @id @default(uuid())
  label      String
  startDate  DateTime
  endDate    DateTime
  orderIndex Int
  createdAt  DateTime @default(now())

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  tsfMappings TSFMapping[]
}

model TSFMapping {
  id           String   @id @default(uuid())
  plannedStart DateTime?
  plannedEnd   DateTime?
  lieu         String?   // 'ENTREPRISE', 'CFA', 'MIXTE'
  status       String    @default("PENDING") // PENDING, ACQUIS, NON_ACQUIS
  
  // Validation flags (simple boolean for MVP)
  flagCfa        Boolean @default(false)
  flagEntreprise Boolean @default(false)

  // Snapshot for non-retroactivity (Deep Copy)
  versionId             String?
  competenceDescription String? 
  blocTitle             String?

  createdAt    DateTime @default(now())

  contractId   String
  contract     Contract   @relation(fields: [contractId], references: [id], onDelete: Cascade)
  competenceId String
  competence   Competence @relation(fields: [competenceId], references: [id], onDelete: Cascade)
  periodId     String?
  period       Period?     @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([contractId, competenceId, periodId])
}

model HistoricalReport {
  id           String   @id @default(uuid())
  type         String   // SEMESTER_REPORT, FINAL_REPORT
  periodLabel  String
  generatedAt  DateTime @default(now())
  
  // Content Snapshot (JSON)
  data         String   // JSON content of the report at that time
  
  // Verification
  verificationHash String
  
  // Relations
  contractId   String
  contract     Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  authorId     String?
  author       User?    @relation(fields: [authorId], references: [id])
}

// 5. Assessments & Proofs
model InitialAssessment {
  id          String    @id @default(uuid())
  status      String    @default("DRAFT") // DRAFT, SUBMITTED, VALIDATED
  submittedAt DateTime?
  validatedAt DateTime?
  createdAt   DateTime  @default(now())

  userId      String // Candidate/Apprentice
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contractId  String?
  contract    Contract?  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  validatorId String? // Formateur/Tutor who validated
  
  positionings Positioning[]
}

model Positioning {
  id           String   @id @default(uuid())
  levelInitial Int // 1-4
  targetLevel  Int? // 1-4
  createdAt    DateTime @default(now())

  // Can belong to Initial Assessment OR just general positioning
  assessmentId String?
  assessment   InitialAssessment? @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  competenceId String
  competence   Competence @relation(fields: [competenceId], references: [id], onDelete: Cascade)
}

model Proof {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        String   // PDF, IMG, VIDEO, LINK
  url         String   // Local path or URL
  status      String   @default("PENDING") // PENDING, VALIDATED, REJECTED
  feedback    String?
  createdAt   DateTime @default(now())

  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  competenceId String?
  competence   Competence? @relation(fields: [competenceId], references: [id])

  comments     ProofComment[]
}

model ProofComment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  proofId   String
  proof     Proof    @relation(fields: [proofId], references: [id], onDelete: Cascade)

  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
}

// 6. Monitoring & Compliance (Qualiopi)
model Milestone {
  id             String    @id @default(uuid())
  type           String    // START_INTERVIEW, PROBATION_REVIEW, SEMESTER_REVIEW
  label          String
  dueDate        DateTime
  status         String    @default("PENDING") // PENDING, COMPLETED, OVERDUE
  completionNote String?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  contractId     String
  contract       Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model Attendance {
  id          String   @id @default(uuid())
  date        DateTime
  hours       Float
  status      String   // PRESENT, ABSENT_JUSTIFIED, ABSENT_UNJUSTIFIED
  type        String   @default("CFA") // CFA, ENTREPRISE
  createdAt   DateTime @default(now())

  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model NotificationLog {
  id          String   @id @default(uuid())
  type        String   // EMAIL, PUSH, ALERT
  recipientId String
  recipient   User     @relation(fields: [recipientId], references: [id])
  title       String
  content     String
  metadata    String?  // JSON string for additional context
  sentAt      DateTime @default(now())
}

// Placeholder for Activities just to be safe if referneced
model Activity {
    id String @id @default(uuid())
    title String
    description String?
    date DateTime?
    createdAt DateTime @default(now())
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Livret (Generated PDF Archive)
model Livret {
    id          String   @id @default(uuid())
    documentId  String   @unique
    filePath    String
    status      String   @default("GENERATED") // GENERATED, SIGNED, ARCHIVED
    generatedAt DateTime @default(now())

    contractId  String
    contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
    
    tenantId    String
    tenant      Tenant   @relation(fields: [tenantId], references: [id])
}

// Leads (Marketing Capture)
model Lead {
    id          String   @id @default(uuid())
    email       String
    source      String?  @default("landing_page")
    tenantName  String?
    status      String   @default("PENDING") // PENDING, PROCESSED, REJECTED
    processedAt DateTime?
    createdAt   DateTime @default(now())

    trainingOfferId String?
    trainingOffer   TrainingOffer? @relation(fields: [trainingOfferId], references: [id])
}

model TrainingOffer {
  id          String   @id @default(uuid())
  title       String   // Marketing Title (e.g. "BTS MCO - Rentr√©e Sept 2026")
  description String?  // Commercial Pitch
  
  // Commercial Info
  status      String   @default("DRAFT") // DRAFT, OPEN, CLOSED, FULL
  price       Float    // Public Price
  funding     String?  // Funding details (OPCO, CPF, etc.)
  
  // Logistics
  startDate   DateTime
  endDate     DateTime
  duration    Int      // In Hours
  campus      String?  // Location
  seats       Int?     // Max capacity, optional

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referentielId String
  referentiel   Referentiel @relation(fields: [referentielId], references: [id], onDelete: Cascade)
  
  leads         Lead[]      // Link leads to specific offers
}
// 7. Platform Wide (Super Admin)
model AuditLog {
    id          String   @id @default(uuid())
    action      String   // E.g., 'CREATE_USER', 'PROVISION_TENANT'
    entityType  String?  // E.g., 'User', 'Tenant'
    entityId    String?
    actorId     String
    tenantId    String?  // Associated tenant if any
    details     String?  // JSON string
    createdAt   DateTime @default(now())
}

model PlatformConfig {
    key         String   @id
    value       String
    description String?
    updatedAt   DateTime @updatedAt
}

// 8. Billing & Subscriptions
model Subscription {
    id        String   @id @default(uuid())
    plan      String   @default("ESSENTIAL") // ESSENTIAL, PRO, ENTERPRISE
    status    String   @default("ACTIVE")    // ACTIVE, EXPIRED, CANCELLED
    startDate DateTime @default(now())
    endDate   DateTime?
    
    tenantId  String   @unique
    tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
    
    invoices  Invoice[]
}

model Invoice {
    id          String   @id @default(uuid())
    amount      Float
    status      String   @default("PAID") // PAID, PENDING, OVERDUE
    dueDate     DateTime
    paidAt      DateTime?
    pdfUrl      String?
    createdAt   DateTime @default(now())

    subscriptionId String
    subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

// 9. Compliance Portal (Audit)
model AuditSession {
    id        String   @id @default(uuid())
    token     String   @unique // Secure random token for URL access
    scope     String   // JSON string of allowed apprentice IDs
    expiresAt DateTime
    
    tenantId  String
    tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
    
    createdBy String   // User ID of the admin who created the session
    createdAt DateTime @default(now())

    accessLogs AuditAccessLog[]
}



// 11. Archiving (RGPD/Qualiopi)
model ArchiveVault {
  id              String   @id @default(uuid())
  apprenticeName  String
  contractRef     String   @unique
  tenantId        String
  
  // The Holy Grail: Full Signed Document
  finalPdfUrl     String
  
  // Compressed Data for future search if needed
  fullHistoryJson String  // Prisma doesn't support JSON on SQLite well, usually. But user said Json. SQLite supports JSON text. Using String to be safe or JSON if using PG. Will use String for dev.db compatibility or JSON if sure. The user code said `Json`. SQLite supports JSON since recent versions but Prisma maps it to String sometimes? No, Prisma supports Json on SQLite.
  // Wait, previous models used Strings for JSON. I should check Config. 
  // User provided: fullHistoryJson Json
  // I will use String for safety on 'dev.db' (SQLite) unless I check capabilities. But schema has `AuditLog` using `details String? // JSON string`. 
  // I will stick to String for JSON content to be consistent with existing `details`.
  
  archivedAt      DateTime @default(now())
  purgeDate       DateTime // J+5 years
  
  @@index([tenantId])
  @@index([purgeDate])
}

model AuditAccessLog {
    id          String   @id @default(uuid())
    resource    String   // E.g., 'CONTRACT:uuid', 'TSF:uuid'
    details     String?  // JSON context (e.g. indicating which indicator)
    accessedAt  DateTime @default(now())

    sessionId   String
    session     AuditSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// 10. RBAC System
model Role {
    id          String   @id @default(uuid())
    name        String
    description String?
    permissions String   // JSON array of permission strings e.g. ["CONTRACT_WRITE", "TSF_VALIDATE"]
    
    tenantId    String
    tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
    
    users       User[]

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@unique([tenantId, name])
}
